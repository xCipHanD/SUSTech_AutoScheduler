let allCourses=[],selectedCourses=new Map;function loadSelectedCourses(){const e=localStorage.getItem("selectedCourses");e&&(selectedCourses=new Map(JSON.parse(e)),updateSelectedList())}async function fetchCourses(){try{const e=await fetch("/lessons.json");allCourses=await e.json()}catch(e){console.error("Failed to fetch courses:",e)}}function searchCourses(e){if(!e)return[];const t=e.trim().toLowerCase().split(/\s+/).filter((e=>e.length>0));return 0===t.length?[]:allCourses.filter((e=>{const s=[e.kcmc.toLowerCase(),e.dgjsmc.toLowerCase(),e.id.toLowerCase(),e.rwmc?e.rwmc.toLowerCase():"",e.kkyxmc?e.kkyxmc.toLowerCase():""].join(" ");return t.every((e=>s.includes(e)))}))}function updateSearchResults(e){document.querySelector(".search-results").innerHTML=e.map((e=>`\n        <div class="course-item">\n            <div class="course-info">\n                <div class="course-name">${e.kcmc}<div class="course-id">${e.rwmc}</div></div>\n                <a class="course-teacher" href="https://ncesnext.com/search/?q=${e.dgjsmc}" target="_blank">${e.dgjsmc}</a>\n                ${e.kkyxmc?`<span class="course-dept">${e.kkyxmc}</span>`:""}\n            </div>\n            <button class="btn" onclick="addCourse('${e.id}')" ${selectedCourses.has(e.id)?"disabled":""}>\n                ${selectedCourses.has(e.id)?"已选":"添加"}\n            </button>\n        </div>\n    `)).join("")}function updateSelectedList(){document.querySelector(".selected-list").innerHTML=Array.from(selectedCourses.values()).map(((e,t)=>`\n        <div class="course-item" \n            draggable="true" \n            data-id="${e.id}"\n            data-priority="${t+1}">\n            <div class="drag-handle">⋮⋮</div>\n            <div class="course-info">\n                <div class="course-name">${e.kcmc}</div>\n                <div class="course-teacher">${e.dgjsmc}</div>\n                <div class="priority-label">优先级: ${t+1}</div>\n            </div>\n            <button class="btn btn-remove" onclick="removeCourse('${e.id}')">删除</button>\n        </div>\n    `)).join(""),updateGenerateButtonState(),setupDragAndDrop(),selectedCourses.size>=10?document.getElementById("clear-btn").style.display="inline":document.getElementById("clear-btn").style.display="none"}function updateGenerateButtonState(){const e=document.querySelector(".generate-btn");e&&(e.disabled=0===selectedCourses.size)}function setupDragAndDrop(){const e=document.querySelectorAll(".selected-list .course-item");document.querySelector(".selected-list");e.forEach((e=>{e.addEventListener("dragstart",handleDragStart),e.addEventListener("dragend",handleDragEnd),e.addEventListener("dragenter",handleDragEnter),e.addEventListener("dragleave",handleDragLeave),e.addEventListener("dragover",handleDragOver),e.addEventListener("drop",handleDragEnd)}))}function handleDragStart(e){e.target.closest(".selected-list")?(e.target.classList.add("dragging"),e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("text/plain",e.target.dataset.id)):e.preventDefault()}function handleDragEnter(e){e.preventDefault(),e.target.classList.contains("course-item")&&!e.target.classList.contains("dragging")&&e.target.classList.add("drag-over")}function handleDragLeave(e){e.preventDefault(),e.target.classList.contains("course-item")&&e.target.classList.remove("drag-over")}function handleDragOver(e){e.preventDefault(),e.dataTransfer.dropEffect="move";const t=document.querySelector(".dragging");if(!t)return;const s=document.querySelector(".selected-list"),r=[...s.querySelectorAll(".course-item:not(.dragging)")].find((t=>{const s=t.getBoundingClientRect();return e.clientY<s.top+s.height/2}));r?s.insertBefore(t,r):s.appendChild(t)}function handleDragEnd(e){e.preventDefault();document.querySelectorAll(".course-item").forEach((e=>{e.classList.remove("dragging","drag-over")})),updatePriorities()}function updatePriorities(){const e=document.querySelectorAll(".selected-list .course-item"),t=new Map;e.forEach(((e,s)=>{const r=e.dataset.id,a=selectedCourses.get(r);a&&(a.priority=s+1,t.set(r,a),e.querySelector(".priority-label").textContent=`优先级: ${s+1}`)})),selectedCourses=t,saveToLocalStorage()}function addCourse(e){const t=allCourses.find((t=>t.id===e));if(t&&!selectedCourses.has(e)){selectedCourses.set(e,t),updateSelectedList(),saveToLocalStorage();const s=document.querySelector(".search-input");if(s&&s.value){updateSearchResults(searchCourses(s.value))}}}function removeCourse(e){if(selectedCourses.has(e)){selectedCourses.delete(e),updateSelectedList(),saveToLocalStorage();const t=document.querySelector(".search-input");if(t&&t.value){updateSearchResults(searchCourses(t.value))}}}function saveToLocalStorage(){const e=Array.from(selectedCourses.entries()).map((([e,t])=>[e,{...t,priority:t.priority,active:!0}]));localStorage.setItem("selectedCourses",JSON.stringify(e))}function selectAllSearchResults(){const e=document.querySelector(".search-input");if(!e||!e.value)return;const t=searchCourses(e.value),s=t.filter((e=>!selectedCourses.has(e.id)));0!==s.length&&(s.forEach((e=>{selectedCourses.set(e.id,e)})),updateSelectedList(),saveToLocalStorage(),updateSearchResults(t))}function deselectAllSearchResults(){const e=document.querySelector(".search-input");if(!e||!e.value)return;const t=searchCourses(e.value),s=t.filter((e=>selectedCourses.has(e.id)));0!==s.length&&(s.forEach((e=>{selectedCourses.delete(e.id)})),updateSelectedList(),saveToLocalStorage(),updateSearchResults(t))}function isExperiment(e){return!(e.id.charCodeAt(e.id.length-1)<60)}function generateSchedule(){if(0!==selectedCourses.size){for(const e of selectedCourses.values())if(isExperiment(e)&&!selectedCourses.has(e.id.substring(0,e.id.length-1)))return void alert(`请先选择 ${e.kcmc} ${e.id.substring(12)} 前置课程 ${e.id.substring(12,e.id.length-1)}`);window.location.href="schedule.html"}else alert("请先选择课程！")}document.addEventListener("DOMContentLoaded",(async()=>{await fetchCourses(),loadSelectedCourses(),updateGenerateButtonState();const e=document.querySelector(".search-input");e&&e.addEventListener("input",(e=>{updateSearchResults(searchCourses(e.target.value))}))}));const searchInput=document.getElementById("search-input");function clearSelectedCourses(){if(confirm("确定要清空已选课程吗？")&&(selectedCourses.clear(),updateSelectedList(),saveToLocalStorage(),searchInput&&searchInput.value)){updateSearchResults(searchCourses(searchInput.value))}}searchInput.addEventListener("input",(function(){document.getElementById("no-result").style.display=this.value?"none":"block"})),document.addEventListener("keydown",(function(e){const t=document.activeElement===searchInput;switch(e.key){case"Enter":generateSchedule();break;case"i":document.activeElement!==searchInput&&(searchInput.focus(),e.preventDefault());break;case"a":case"A":t&&e.ctrlKey&&e.shiftKey&&(e.preventDefault(),selectAllSearchResults());break;case"d":case"D":t&&e.ctrlKey&&e.shiftKey&&(e.preventDefault(),deselectAllSearchResults())}}));