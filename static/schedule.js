let selectedCourses=new Map,curriculumResults=[];const currentResult=document.getElementById("currentResult"),totalResult=document.getElementById("totalResults"),colors=["#eea2a4","#f0a1a8","#c45a65","#ef82a0","#d276a3","#d1c2d3","#93b5cf","#d8e3e7","#c6e6e8","#92b3a5","#b9dec9","#add5a2","#d2d97a","#f8df72","#f9d770","#ee8055"];function loadSelectedCourses(){const e=localStorage.getItem("selectedCourses");return e?new Map(JSON.parse(e)):(window.location.href="index.html",null)}function saveToLocalStorage(){const e=Array.from(selectedCourses.entries()).map((([e,t])=>[e,{...t}]));localStorage.setItem("selectedCourses",JSON.stringify(e))}function arrangeSchedule(e){curriculumResults=[];let t={};for(c of e.values())if(c.active)if(t[c.kcmc]||(t[c.kcmc]=[]),(r=c).id.charCodeAt(r.id.length-1)<60)1==e.keys().toArray().filter((e=>e.startsWith(c.id))).length&&t[c.kcmc].push([c]);else{let r=e.get(c.id.substring(0,c.id.length-1));if(!e.has(r.id)||!r.active)return void console.log(`请先选择 ${c.kcmc} ${c.id.substring(12)} 前置课程 ${c.id.substring(12,c.id.length-1)}`);t[c.kcmc].push([r,c])}var r;let n=Object.keys(t);document.getElementById("selectedCounts").innerHTML=`(${n.length})`;console.log(t),dfs([],n,t,curriculumResults),console.log(curriculumResults)}function isSameCombination(e,t){if(e.length!==t.length)return!1;const r=e=>{const t=new Set;return e.forEach((e=>{e.forEach((e=>{t.add(e.id)}))})),t},n=r(e),s=r(t);if(n.size!==s.size)return!1;for(let e of n)if(!s.has(e))return!1;return!0}function visited(e,t){for(let r=0;r<e.length;r++)if(e[r][0].kcmc===t)return!0;return!1}function valid(e,t){let r=[];for(let t=0;t<e.length;t++)for(let n=0;n<e[t].length;n++)r.push(...e[t][n].time);for(let e=0;e<t.length;e++)for(let n=0;n<t[e].time.length;n++)if(r.includes(t[e].time[n]))return!1;return!0}function dfs(e,t,r,n){let s=!1;for(lesson of t){if(visited(e,lesson))continue;let l=r[lesson];for(let c=0;c<l.length;c++)if(valid(e,l[c])){s=!0;let o=[];o.push(...e),o.push(l[c]),dfs(o,t,r,n)}}if(!s){n.some((t=>isSameCombination(t,e)))||n.push(e)}}function renderSchedule(e){const t=document.querySelectorAll("#oddWeek tbody tr"),r=document.querySelectorAll("#evenWeek tbody tr");if(document.querySelectorAll("td").forEach((e=>{e.classList.contains("time-cell")||(e.innerHTML="",e.style.backgroundColor="transparent")})),0===curriculumResults.length)return;currentResult.innerHTML=e+1,totalResult.innerHTML=curriculumResults.length;const n=curriculumResults[e];console.log("绘制课程表",e);for(let e=0;e<n.length;e++)for(let s=0;s<n[e].length;s++){const l=n[e][s];if(l){let e=colors[Math.random()*colors.length|0];for(let n=0;n<l.time.length;n++){let s="1"===l.time[n].substring(0,1),c=(l.time[n].substring(2,3)-1)/2,o=l.time[n].substring(1,2),a=s?t[c].getElementsByTagName("td"):r[c].getElementsByTagName("td");a[o].innerHTML=`<div class="course-name">${l.kcmc}</div><div class="course-teacher">${l.dgjsmc}</div>`,a[o].style.backgroundColor=""+(e+"55")}}}}function paging(e){let t=parseInt(currentResult.innerHTML),r=curriculumResults.length;if("prev"===e){if(1===t)return;t--}else if("next"===e){if(t===r)return;t++}else{if(1===t&&e<0||t===r&&e>0)return;t+=e,t<1&&(t=1),t>r&&(t=r)}renderSchedule(t-1)}function updateSelectedList(){document.querySelector(".selected-list").innerHTML=Array.from(selectedCourses.values()).map(((e,t)=>`\n        <div class="course-item" \n            draggable="true" \n            data-id="${e.id}"\n            data-priority="${t+1}">\n            <div class="drag-handle">⋮⋮</div>\n            <div class="course-info">\n                <div class="course-name">${e.kcmc}</div>\n                <div class="course-teacher">${e.dgjsmc}</div>\n                <div class="priority-label">优先级: ${t+1}</div>\n            </div>\n            <label class="toggle-switch">\n                <input type="checkbox" \n                    ${!1!==e.active?"checked":""} \n                    onchange="toggleCourse('${e.id}', this.checked)">\n                <span class="toggle-slider"></span>\n            </label>\n        </div>\n    `)).join(""),setupDragAndDrop()}function toggleCourse(e,t){const r=selectedCourses.get(e);r&&(r.active=t,saveToLocalStorage(),arrangeSchedule(selectedCourses),renderSchedule(0))}function setupDragAndDrop(){document.querySelectorAll(".selected-list .course-item").forEach((e=>{e.addEventListener("dragstart",handleDragStart),e.addEventListener("dragenter",handleDragEnter),e.addEventListener("dragleave",handleDragLeave),e.addEventListener("dragover",handleDragOver),e.addEventListener("drop",handleDrop)}))}function handleDragStart(e){e.target.closest(".selected-list")?(e.target.classList.add("dragging"),e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("text/plain",e.target.dataset.id)):e.preventDefault()}function handleDragEnter(e){e.preventDefault(),e.target.classList.contains("course-item")&&!e.target.classList.contains("dragging")&&e.target.classList.add("drag-over")}function handleDragLeave(e){e.preventDefault(),e.target.classList.contains("course-item")&&e.target.classList.remove("drag-over")}function handleDragOver(e){e.preventDefault(),e.dataTransfer.dropEffect="move";const t=document.querySelector(".dragging");if(!t)return;const r=document.querySelector(".selected-list"),n=[...r.querySelectorAll(".course-item:not(.dragging)")].find((t=>{const r=t.getBoundingClientRect();return e.clientY<r.top+r.height/2}));n?r.insertBefore(t,n):r.appendChild(t)}function handleDrop(e){e.preventDefault();document.querySelectorAll(".course-item").forEach((e=>{e.classList.remove("dragging","drag-over")})),updatePriorities()}function updatePriorities(){const e=document.querySelectorAll(".selected-list .course-item"),t=new Map;e.forEach(((e,r)=>{const n=e.dataset.id,s=selectedCourses.get(n);s&&(s.priority=r+1,t.set(n,s),e.querySelector(".priority-label").textContent=`优先级: ${r+1}`)})),selectedCourses=t,saveToLocalStorage(),arrangeSchedule(selectedCourses),renderSchedule(0)}function backToSelection(){window.location="/select.html"}document.addEventListener("DOMContentLoaded",(()=>{const e=loadSelectedCourses();e&&(selectedCourses=e,arrangeSchedule(selectedCourses),renderSchedule(0),updateSelectedList())})),document.getElementById("prevWeek").addEventListener("click",(()=>paging("prev"))),document.getElementById("nextWeek").addEventListener("click",(()=>paging("next"))),document.addEventListener("keydown",(e=>{let t=Math.round(curriculumResults.length/10);"ArrowLeft"===e.key||"h"===e.key?paging(e.shiftKey?-t:"prev"):"ArrowRight"!==e.key&&"l"!==e.key||paging(e.shiftKey?t:"next"),"Backspace"===e.key&&backToSelection(),console.log(e.key)}));