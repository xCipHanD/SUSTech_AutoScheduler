let selectedCourses=new Map,curriculumResults=[];const currentResult=document.getElementById("currentResult"),totalResult=document.getElementById("totalResults"),colors=["#eea2a4","#f0a1a8","#c45a65","#ef82a0","#d276a3","#d1c2d3","#93b5cf","#d8e3e7","#c6e6e8","#92b3a5","#b9dec9","#add5a2","#d2d97a","#f8df72","#f9d770","#ee8055"];function loadSelectedCourses(){const e=localStorage.getItem("selectedCourses");return e?new Map(JSON.parse(e)):(window.location.href="index.html",null)}function saveToLocalStorage(){const e=Array.from(selectedCourses.entries()).map((([e,t])=>[e,{...t}]));localStorage.setItem("selectedCourses",JSON.stringify(e))}function arrangeSchedule(e){curriculumResults=[];let t={};for(c of e.values())if(c.active)if(t[c.kcmc]||(t[c.kcmc]=[]),(n=c).id.charCodeAt(n.id.length-1)<60)1==e.keys().toArray().filter((e=>e.startsWith(c.id))).length&&t[c.kcmc].push([c]);else{let n=e.get(c.id.substring(0,c.id.length-1));if(!e.has(n.id)||!n.active)return void console.log(`请先选择 ${c.kcmc} ${c.id.substring(12)} 前置课程 ${c.id.substring(12,c.id.length-1)}`);t[c.kcmc].push([n,c])}var n;let r=Object.keys(t);document.getElementById("selectedCounts").innerHTML=`(${r.length})`;console.log(t),dfs([],r,t,curriculumResults),console.log(curriculumResults)}function isSameCombination(e,t){if(e.length!==t.length)return!1;const n=e=>{const t=new Set;return e.forEach((e=>{e.forEach((e=>{t.add(e.id)}))})),t},r=n(e),s=n(t);if(r.size!==s.size)return!1;for(let e of r)if(!s.has(e))return!1;return!0}function visited(e,t){for(let n=0;n<e.length;n++)if(e[n][0].kcmc===t)return!0;return!1}function valid(e,t){let n=[];for(let t=0;t<e.length;t++)for(let r=0;r<e[t].length;r++)n.push(...e[t][r].time);for(let e=0;e<t.length;e++)for(let r=0;r<t[e].time.length;r++)if(n.includes(t[e].time[r]))return!1;return!0}function dfs(e,t,n,r){let s=!1;for(lesson of t){if(visited(e,lesson))continue;let l=n[lesson];for(let c=0;c<l.length;c++)if(valid(e,l[c])){s=!0;let o=[];o.push(...e),o.push(l[c]),dfs(o,t,n,r)}}if(!s){r.some((t=>isSameCombination(t,e)))||r.push(e)}}function renderSchedule(e){const t=document.querySelectorAll("#oddWeek tbody tr"),n=document.querySelectorAll("#evenWeek tbody tr");if(document.querySelectorAll("td").forEach((e=>{e.classList.contains("time-cell")||(e.innerHTML="",e.style.backgroundColor="transparent")})),0===curriculumResults.length)return;currentResult.innerHTML=e+1,totalResult.innerHTML=curriculumResults.length;const r=curriculumResults[e];console.log("绘制课程表",e);for(let e=0;e<r.length;e++)for(let s=0;s<r[e].length;s++){const l=r[e][s];if(l){let e=colors[Math.random()*colors.length|0];for(let r=0;r<l.time.length;r++){let s="1"===l.time[r].substring(0,1),c=(l.time[r].substring(2,3)-1)/2,o=l.time[r].substring(1,2),a=s?t[c].getElementsByTagName("td"):n[c].getElementsByTagName("td");a[o].innerHTML=`<div class="course-name">${l.kcmc}</div><div class="course-teacher">${l.dgjsmc}</div>`,a[o].style.backgroundColor=""+(e+"55")}}}}function paging(e){let t=parseInt(currentResult.innerHTML),n=curriculumResults.length;if("prev"===e){if(1===t)return;t--}else if("next"===e){if(t===n)return;t++}else{if(1===t&&e<0||t===n&&e>0)return;t+=e,t<1&&(t=1),t>n&&(t=n)}renderSchedule(t-1)}function updateSelectedList(){document.querySelector(".selected-list").innerHTML=Array.from(selectedCourses.values()).map(((e,t)=>`\n        <div class="course-item" \n            draggable="true" \n            data-id="${e.id}"\n            data-priority="${t+1}">\n            <div class="drag-handle">⋮⋮</div>\n            <div class="course-info">\n                <div class="course-name">${e.kcmc}</div>\n                <div class="course-teacher">${e.dgjsmc}</div>\n                <div class="priority-label">优先级: ${t+1}</div>\n            </div>\n            <label class="toggle-switch">\n                <input type="checkbox" \n                    ${!1!==e.active?"checked":""} \n                    onchange="toggleCourse('${e.id}', this.checked)">\n                <span class="toggle-slider"></span>\n            </label>\n        </div>\n    `)).join(""),setupDragAndDrop()}function toggleCourse(e,t){const n=selectedCourses.get(e);n&&(n.active=t,saveToLocalStorage(),arrangeSchedule(selectedCourses),renderSchedule(0))}function setupDragAndDrop(){document.querySelectorAll(".selected-list .course-item").forEach((e=>{e.addEventListener("dragstart",handleDragStart),e.addEventListener("dragenter",handleDragEnter),e.addEventListener("dragleave",handleDragLeave),e.addEventListener("dragover",handleDragOver),e.addEventListener("drop",handleDrop)}))}function handleDragStart(e){e.target.closest(".selected-list")?(e.target.classList.add("dragging"),e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("text/plain",e.target.dataset.id)):e.preventDefault()}function handleDragEnter(e){e.preventDefault(),e.target.classList.contains("course-item")&&!e.target.classList.contains("dragging")&&e.target.classList.add("drag-over")}function handleDragLeave(e){e.preventDefault(),e.target.classList.contains("course-item")&&e.target.classList.remove("drag-over")}function handleDragOver(e){e.preventDefault(),e.dataTransfer.dropEffect="move";const t=document.querySelector(".dragging");if(!t)return;const n=document.querySelector(".selected-list"),r=[...n.querySelectorAll(".course-item:not(.dragging)")].find((t=>{const n=t.getBoundingClientRect();return e.clientY<n.top+n.height/2}));r?n.insertBefore(t,r):n.appendChild(t)}function handleDrop(e){e.preventDefault();document.querySelectorAll(".course-item").forEach((e=>{e.classList.remove("dragging","drag-over")})),updatePriorities()}function updatePriorities(){const e=document.querySelectorAll(".selected-list .course-item"),t=new Map;e.forEach(((e,n)=>{const r=e.dataset.id,s=selectedCourses.get(r);s&&(s.priority=n+1,t.set(r,s),e.querySelector(".priority-label").textContent=`优先级: ${n+1}`)})),selectedCourses=t,saveToLocalStorage(),arrangeSchedule(selectedCourses),renderSchedule(0)}function backToSelection(){window.location="/select.html"}document.addEventListener("DOMContentLoaded",(()=>{const e=loadSelectedCourses();e&&(selectedCourses=e,arrangeSchedule(selectedCourses),renderSchedule(0),updateSelectedList())})),document.getElementById("prevWeek").addEventListener("click",(()=>paging("prev"))),document.getElementById("nextWeek").addEventListener("click",(()=>paging("next"))),document.addEventListener("keydown",(e=>{let t=Math.round(curriculumResults.length/10);"ArrowLeft"===e.key||"h"===e.key?paging(e.shiftKey?-t:"prev"):"ArrowRight"!==e.key&&"l"!==e.key||paging(e.shiftKey?t:"next"),"Backspace"===e.key&&backToSelection(),console.log(e.key)})),document.getElementById("saveAsImage").addEventListener("click",(()=>{alert("开发中")})),document.getElementById("saveAsJson").addEventListener("click",(()=>{alert("开发中")}));