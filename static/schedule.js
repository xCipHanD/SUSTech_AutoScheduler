let selectedCourses=new Map,curriculumResults=[];const currentResult=document.getElementById("currentResult"),totalResult=document.getElementById("totalResults"),colors=["#eea2a4","#f0a1a8","#c45a65","#ef82a0","#d276a3","#d1c2d3","#93b5cf","#d8e3e7","#c6e6e8","#92b3a5","#b9dec9","#add5a2","#d2d97a","#f8df72","#f9d770","#ee8055"];function recolorCourseById(e){const t=document.querySelectorAll(`td[data-course-id="${e}"]`);if(!t.length)return;let n=t[0].dataset.bg||"",r=n;for(let e=0;e<8;e++){const e=colors[Math.random()*colors.length|0]+"55";if(e!==n){r=e;break}}t.forEach((e=>{e.style.backgroundColor=r,e.dataset.bg=r}))}function loadSelectedCourses(){const e=localStorage.getItem("selectedCourses");return e?new Map(JSON.parse(e)):(window.location.href="index.html",null)}function saveToLocalStorage(){const e=Array.from(selectedCourses.entries()).map((([e,t])=>[e,{...t}]));localStorage.setItem("selectedCourses",JSON.stringify(e))}function arrangeSchedule(e){function t(t){const n=t.id.charAt(t.id.length-1);if(n>="0"&&n<="9")return!1;const r=t.id.slice(0,-1);return e.has(r)}curriculumResults=[];const n=Object.create(null),r=[],o=Array.from(e.values());for(const u of o){if(!1===u?.active)continue;if(t(u)){r.push(u);continue}const d=u.kcmc;n[d]||(n[d]=[]);const f=[];for(const g of o)!1!==g?.active&&t(g)&&g.id.startsWith(u.id)&&f.push(g);if(f.length>0)for(const m of f)n[d].push([u,m]);else n[d].push([u])}const s=Object.keys(n);if(document.getElementById("selectedCounts").innerHTML=`(${s.length})`,0===s.length)return currentResult.innerHTML=0,void(totalResult.innerHTML=0);const c=new Map;o.forEach(((e,t)=>{!1!==e?.active&&(c.has(e.kcmc)||c.set(e.kcmc,t))})),s.sort(((e,t)=>(c.get(e)??0)-(c.get(t)??0))),s.forEach((e=>{n[e].sort(((e,t)=>e.reduce(((e,t)=>e+(t.time&&t.time.length||0)),0)-t.reduce(((e,t)=>e+(t.time&&t.time.length||0)),0)))}));const l=new Set,a=[];if(function e(t){if(t===s.length)return void curriculumResults.push(a.map((e=>e.slice())));const r=s[t],o=n[r];for(const n of o){let r=!0;for(const e of n){const t=e.time||[];for(const e of t)if(l.has(e)){r=!1;break}if(!r)break}if(r){a.push(n);for(const e of n){const t=e.time||[];for(const e of t)l.add(e)}e(t+1);for(const e of n){const t=e.time||[];for(const e of t)l.delete(e)}a.pop()}}}(0),0===curriculumResults.length){const h=256;for(let p=1;p<=s.length-1;p++){const v=[],y=new Set,S=[];function i(e,t){if(v.length>=h)return;if(e===s.length)return void(S.length>0&&(r=S,v.some((e=>isSameCombination(e,r)))||v.push(r.map((e=>e.slice())))));var r;const o=s[e],c=n[o];for(const n of c){let r=!0;for(const e of n){for(const t of e.time||[])if(y.has(t)){r=!1;break}if(!r)break}if(r){S.push(n);for(const e of n)for(const t of e.time||[])y.add(t);i(e+1,t);for(const e of n)for(const t of e.time||[])y.delete(t);if(S.pop(),v.length>=h)return}}t>0&&i(e+1,t-1)}if(i(0,p),v.length>0){curriculumResults=v;break}}}0===curriculumResults.length&&(currentResult.innerHTML=0,totalResult.innerHTML=0)}function isSameCombination(e,t){if(e.length!==t.length)return!1;const n=e=>{const t=new Set;return e.forEach((e=>{e.forEach((e=>{t.add(e.id)}))})),t},r=n(e),o=n(t);if(r.size!==o.size)return!1;for(let e of r)if(!o.has(e))return!1;return!0}function visited(e,t){for(let n=0;n<e.length;n++)if(e[n][0].kcmc===t)return!0;return!1}function valid(e,t){let n=[];for(let t=0;t<e.length;t++)for(let r=0;r<e[t].length;r++)n.push(...e[t][r].time);for(let e=0;e<t.length;e++)for(let r=0;r<t[e].time.length;r++)if(n.includes(t[e].time[r]))return!1;return!0}function dfs(e,t,n,r){let o=!1;for(lesson of t){if(visited(e,lesson))continue;let s=n[lesson];for(let c=0;c<s.length;c++)if(valid(e,s[c])){o=!0;let l=[];l.push(...e),l.push(s[c]),dfs(l,t,n,r)}}if(!o){r.some((t=>isSameCombination(t,e)))||r.push(e)}}function renderSchedule(e){const t=document.querySelectorAll("#oddWeek tbody tr"),n=document.querySelectorAll("#evenWeek tbody tr");if(document.querySelectorAll("td").forEach((e=>{e.classList.contains("time-cell")||(e.innerHTML="",e.style.backgroundColor="transparent",e.classList.remove("course-slot"),e.removeAttribute("data-course-id"),e.removeAttribute("data-bg"),e.removeAttribute("data-bghi"))})),0===curriculumResults.length){const e=document.getElementById("planCourseCount");return void(e&&(e.textContent="0"))}currentResult.innerHTML=e+1,totalResult.innerHTML=curriculumResults.length;const r=curriculumResults[e],o=document.getElementById("planCourseCount");o&&(o.textContent=String(r.length||0)),console.log("绘制课程表",e);for(let e=0;e<r.length;e++)for(let o=0;o<r[e].length;o++){const s=r[e][o];if(s){let e=colors[Math.random()*colors.length|0];for(let r=0;r<(s.time?.length||0);r++){const o=s.time[r],c="1"===o?.charAt(0),l=parseInt(o?.slice(1,2),10),a=0===l?7:l,i=parseInt(o?.slice(2,3),10),u=Math.floor((i-1)/2);if(!Number.isInteger(a)||a<1||a>7)continue;if(!Number.isInteger(u)||u<0||u>=t.length)continue;const d=c?t[u].getElementsByTagName("td"):n[u].getElementsByTagName("td");if(!d||a>=d.length)continue;const f=e+"55";d[a].innerHTML=`<div class="course-name">${s.kcmc}</div><div class="course-teacher">${s.dgjsmc}</div>`,d[a].style.backgroundColor=f,d[a].dataset.bg=f,d[a].classList.add("course-slot"),d[a].dataset.courseId=s.id,d[a].onclick=()=>recolorCourseById(s.id)}}}}function paging(e){let t=parseInt(currentResult.innerHTML),n=curriculumResults.length;if("prev"===e)1===t?t=n:t--;else if("next"===e)t===n?t=1:t++;else{if(1===t&&e<0||t===n&&e>0)return;t+=e,t<1&&(t=1),t>n&&(t=n)}renderSchedule(t-1)}function updateSelectedList(){document.querySelector(".selected-list").innerHTML=Array.from(selectedCourses.values()).map(((e,t)=>`\n        <div class="course-item" \n            draggable="true" \n            data-id="${e.id}"\n            data-priority="${t+1}">\n            <div class="drag-handle">⋮⋮</div>\n            <div class="course-info">\n                <div class="course-name">${e.kcmc}</div>\n                <div class="course-teacher">${e.dgjsmc}</div>\n                <div class="priority-label">优先级: ${t+1}</div>\n            </div>\n            <label class="toggle-switch">\n                <input type="checkbox" \n                    ${!1!==e.active?"checked":""} \n                    onchange="toggleCourse('${e.id}', this.checked)">\n                <span class="toggle-slider"></span>\n            </label>\n        </div>\n    `)).join(""),setupDragAndDrop()}function toggleCourse(e,t){const n=selectedCourses.get(e);n&&(n.active=t,saveToLocalStorage(),arrangeSchedule(selectedCourses),renderSchedule(0))}function setupDragAndDrop(){document.querySelectorAll(".selected-list .course-item").forEach((e=>{e.addEventListener("dragstart",handleDragStart),e.addEventListener("dragenter",handleDragEnter),e.addEventListener("dragleave",handleDragLeave),e.addEventListener("dragover",handleDragOver),e.addEventListener("drop",handleDrop)}))}function handleDragStart(e){e.target.closest(".selected-list")?(e.target.classList.add("dragging"),e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("text/plain",e.target.dataset.id)):e.preventDefault()}function handleDragEnter(e){e.preventDefault(),e.target.classList.contains("course-item")&&!e.target.classList.contains("dragging")&&e.target.classList.add("drag-over")}function handleDragLeave(e){e.preventDefault(),e.target.classList.contains("course-item")&&e.target.classList.remove("drag-over")}function handleDragOver(e){e.preventDefault(),e.dataTransfer.dropEffect="move";const t=document.querySelector(".dragging");if(!t)return;const n=document.querySelector(".selected-list"),r=[...n.querySelectorAll(".course-item:not(.dragging)")].find((t=>{const n=t.getBoundingClientRect();return e.clientY<n.top+n.height/2}));r?n.insertBefore(t,r):n.appendChild(t)}function handleDrop(e){e.preventDefault();document.querySelectorAll(".course-item").forEach((e=>{e.classList.remove("dragging","drag-over")})),updatePriorities()}function updatePriorities(){const e=document.querySelectorAll(".selected-list .course-item"),t=new Map;e.forEach(((e,n)=>{const r=e.dataset.id,o=selectedCourses.get(r);o&&(o.priority=n+1,t.set(r,o),e.querySelector(".priority-label").textContent=`优先级: ${n+1}`)})),selectedCourses=t,saveToLocalStorage(),arrangeSchedule(selectedCourses),renderSchedule(0)}function backToSelection(){window.location="/select.html"}async function saveAsImage(){if(0!==curriculumResults.length)try{window.modernScreenshot.domToPng(document.getElementById("scheduleGrid")).then((e=>{const t=document.createElement("a");t.download=`课程表_方案${currentResult.innerHTML}.png`,t.href=e,t.click()}))}catch(e){console.error("导出图片时发生错误:",e),alert("导出图片失败，请稍后重试！")}else alert("没有可导出的课表！")}function saveAsCSV(){if(0===curriculumResults.length)return void alert("没有可导出的数据！");const e=parseInt(currentResult.innerHTML)-1,t=curriculumResults[e],n=["第一、二节 (8:00-9:50)","第三、四节 (10:20-12:10)","第五、六节 (14:00-15:50)","第七、八节 (16:20-18:10)","第九、十节 (19:00-20:50)"],r=["周一","周二","周三","周四","周五","周六","周日"],o=Array(5).fill().map((()=>Array(7).fill(""))),s=Array(5).fill().map((()=>Array(7).fill("")));t.forEach((e=>{e.forEach((e=>{e.time&&e.time.forEach((t=>{const n="1"===t.substring(0,1),r=parseInt(t.substring(1,2),10),c=0===r?6:r-1,l=Math.floor((parseInt(t.substring(2,3),10)-1)/2);if(c<0||c>6)return;if(l<0||l>4)return;const a=`${e.kcmc}\n${e.dgjsmc}`;n?o[l][c]=a:s[l][c]=a}))}))}));let c="\ufeff";c+="课程表数据导出\n",c+=`导出时间,${(new Date).toLocaleString("zh-CN")}\n`,c+=`方案编号,${e+1}/${curriculumResults.length}\n\n`,c+="单周课表\n",c+="时间,"+r.join(",")+"\n",n.forEach(((e,t)=>{const n=[e,...o[t].map((e=>e.replace(/\n/g," - ").replace(/,/g,"，")))];c+=n.join(",")+"\n"})),c+="\n",c+="双周课表\n",c+="时间,"+r.join(",")+"\n",n.forEach(((e,t)=>{const n=[e,...s[t].map((e=>e.replace(/\n/g," - ").replace(/,/g,"，")))];c+=n.join(",")+"\n"})),c+="\n",c+="课程详细信息\n",c+="课程名称,教师,课程ID,开课院系,时间安排\n";const l=new Map;t.forEach((e=>{e.forEach((e=>{if(!l.has(e.id)){const t=e.time?e.time.map((e=>{const t="1"===e.substring(0,1),o=parseInt(e.substring(1,2),10);return`${t?"单":"双"}周${r[0===o?6:o-1]}${n[Math.floor((parseInt(e.substring(2,3),10)-1)/2)]}`})).join("；"):"";l.set(e.id,{name:e.kcmc,teacher:e.dgjsmc,id:e.id,department:e.kkyxmc||"",time:t})}}))})),l.forEach((e=>{const t=[e.name.replace(/,/g,"，"),e.teacher.replace(/,/g,"，"),e.id,e.department.replace(/,/g,"，"),e.time.replace(/,/g,"，")];c+=t.join(",")+"\n"}));const a=new Blob([c],{type:"text/csv;charset=utf-8;"}),i=document.createElement("a");i.download=`课程表数据_方案${e+1}_${(new Date).toISOString().slice(0,10)}.csv`,i.href=URL.createObjectURL(a),i.click(),URL.revokeObjectURL(i.href)}document.addEventListener("DOMContentLoaded",(()=>{const e=loadSelectedCourses();e&&(selectedCourses=e,arrangeSchedule(selectedCourses),renderSchedule(0),updateSelectedList())})),document.getElementById("prevWeek").addEventListener("click",(()=>paging("prev"))),document.getElementById("nextWeek").addEventListener("click",(()=>paging("next"))),document.addEventListener("keydown",(e=>{let t=Math.round(curriculumResults.length/10);"ArrowLeft"===e.key||"h"===e.key?paging(e.shiftKey?-t:"prev"):"ArrowRight"!==e.key&&"l"!==e.key||paging(e.shiftKey?t:"next"),"Backspace"===e.key&&backToSelection(),console.log(e.key)})),document.getElementById("saveAsImage").addEventListener("click",saveAsImage),document.getElementById("saveAsJson").addEventListener("click",saveAsCSV);